<script lang="ts">
  import Check from 'lucide-svelte/icons/check';
  import ChevronsUpDown from 'lucide-svelte/icons/chevrons-up-down';
  import { createEventDispatcher, tick } from 'svelte';
  import * as Command from '$lib/components/ui/command/index.js';
  import * as Popover from '$lib/components/ui/popover/index.js';
  import { Button } from '$lib/components/ui/button/index.js';
  import { cn } from '$lib/utils/shadcn.js';

  interface Props {
    items?: { value: string; label: string }[];
    value?: string;
    placeholder?: string;
    searchPlaceholder?: string;
    empty?: string;
  }

  let {
    items = [],
    value = '',
    placeholder = 'Select...',
    searchPlaceholder = 'Search...',
    empty = 'No matches found.',
  }: Props = $props();

  const dispatch = createEventDispatcher();
  let open = $state(false);

  let selectedValue = $derived(items.find((f) => f.value === value)?.label ?? placeholder);

  // We want to refocus the trigger button when the user selects
  // an item from the list so users can continue navigating the
  // rest of the form with the keyboard.
  function closeAndFocusTrigger(triggerId: string) {
    open = false;
    tick()
      .then(() => {
        document.getElementById(triggerId)?.focus();
      })
      .catch((reason: unknown) => {
        console.error('Tick failed', reason);
      });
  }

  function castPopoverIds(popoverIds: unknown): { content: string; trigger: string } {
    return popoverIds as { content: string; trigger: string };
  }
</script>

<Popover.Root bind:open>
  {#snippet children({ ids })}
    <Popover.Trigger asChild>
      {#snippet children({ builder })}
        <Button
          builders={[builder]}
          variant="outline"
          role="combobox"
          aria-expanded={open}
          class="w-auto justify-between"
        >
          {selectedValue}
          <ChevronsUpDown class="ml-2 h-4 w-4 shrink-0 opacity-50" />
        </Button>
      {/snippet}
    </Popover.Trigger>
    <Popover.Content class="w-auto p-0" align="start">
      <Command.Root>
        <Command.Input placeholder={searchPlaceholder} />
        <Command.Empty>{empty}</Command.Empty>
        <Command.Group>
          {#each items as item}
            <Command.Item
              onSelect={() => {
                dispatch('select', item.value);
                closeAndFocusTrigger(castPopoverIds(ids).trigger);
              }}
            >
              <Check class={cn('mr-2 h-4 w-4', value !== item.value && 'text-transparent')} />
              {item.label}
            </Command.Item>
          {/each}
        </Command.Group>
      </Command.Root>
    </Popover.Content>
  {/snippet}
</Popover.Root>
